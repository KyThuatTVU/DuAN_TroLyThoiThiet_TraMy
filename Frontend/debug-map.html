<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Map API</title>
</head>
<body>
    <h1>Debug Map API</h1>
    <input type="text" id="cityInput" placeholder="Nhập tên thành phố" value="Hanoi">
    <button onclick="testAPI()">Test API</button>
    <button onclick="testMap()">Test Map Display</button>
    <div id="result" style="margin: 20px 0; padding: 10px; border: 1px solid #ccc; min-height: 100px;"></div>
    <div id="mapDisplay" style="width: 100%; height: 400px; border: 1px solid #ddd; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
        Map will appear here
    </div>

    <script>
        async function testAPI() {
            const city = document.getElementById('cityInput').value;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing API...';

            const soapRequestXML = `
                <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:weat="http://example.com/weather">
                   <soapenv:Header/>
                   <soapenv:Body>
                      <weat:getLocationRequest>
                         <city>${city}</city>
                      </weat:getLocationRequest>
                   </soapenv:Body>
                </soapenv:Envelope>`;

            try {
                const response = await fetch('http://localhost:3000/weather', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/xml; charset=utf-8',
                        'SOAPAction': 'getLocation'
                    },
                    body: soapRequestXML
                });

                const xmlText = await response.text();
                resultDiv.innerHTML = '<pre>' + xmlText + '</pre>';

                // Parse XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                const lat = xmlDoc.querySelector('latitude')?.textContent ||
                           xmlDoc.querySelector('*[localName="latitude"]')?.textContent;
                const lon = xmlDoc.querySelector('longitude')?.textContent ||
                           xmlDoc.querySelector('*[localName="longitude"]')?.textContent;

                resultDiv.innerHTML += '<br><br>Parsed: lat=' + lat + ', lon=' + lon;

                if (lat && lon) {
                    window.testLat = parseFloat(lat);
                    window.testLon = parseFloat(lon);
                    resultDiv.innerHTML += '<br><br><button onclick="testMap()">Show Map</button>';
                }

            } catch (error) {
                resultDiv.innerHTML = 'Error: ' + error.message;
            }
        }

        function testMap() {
            const lat = window.testLat || 21.02945;
            const lon = window.testLon || 105.854444;

            const mapDisplay = document.getElementById('mapDisplay');
            mapDisplay.innerHTML = `
                <iframe
                    src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}"
                    width="100%"
                    height="100%"
                    style="border:0;">
                </iframe>`;
        }
    </script>
</body>
</html>